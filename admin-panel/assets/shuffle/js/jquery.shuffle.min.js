(function($,Modernizr){$.fn.sorted=function(options){var opts=$.extend({},$.fn.sorted.defaults,options),arr=this.get();if(opts.by!==$.noop&&opts.by!==null&&opts.by!==undefined)arr.sort(function(a,b){var valA=opts.by($(a));var valB=opts.by($(b));return valA<valB?-1:valA>valB?1:0});if(opts.reverse)arr.reverse();return arr};$.fn.sorted.defaults={reverse:false,by:null};var Shuffle=function($container,options){var self=this;$.extend(self,$.fn.shuffle.options,options,$.fn.shuffle.settings);self.$container=
$container;self.$items=self.$container.children();self.$item=self.$items.first();self.marginTop=parseInt(self.$item.css("marginTop"),10);self.marginRight=parseInt(self.$item.css("marginRight"),10);self.transitionName=self.prefixed("transition"),self.transform=self.getPrefixed("transform");var transEndEventNames={"WebkitTransition":"webkitTransitionEnd","MozTransition":"transitionend","OTransition":"oTransitionEnd","msTransition":"MSTransitionEnd","transition":"transitionend"};self.transitionEndName=
transEndEventNames[self.transitionName];self.itemCss={position:"absolute",top:0,left:0,opacity:1};self.$container.css("position","relative").get(0).style[self.transitionName]="height "+self.speed+"ms "+self.easing;self.$items.each(function(){$(this).css(self.itemCss);if(self.supported)this.style[self.transitionName]=self.transform+" "+self.speed+"ms "+self.easing+", opacity "+self.speed+"ms "+self.easing;this.style.marginTop=0;this.style.marginRight=0});self.itemWidth=self.$item.outerWidth();self.itemHeight=
self.$item.outerHeight();self.itemsPerRow=self.getItemsPerRow();self.windowHeight=$(window).height();self.windowWidth=$(window).width();$(window).on("resize.shuffle",function(){var height=$(window).height(),width=$(window).width();if(width!==self.windowWidth||height!==self.windowHeight){self.resized();self.windowHeight=height;self.windowWidth=width}});if(self.itemWidth===0||self.itemHeight===0)$(window).on("load.shuffle",function(){self.itemWidth=self.$item.outerWidth();self.itemHeight=self.$item.outerHeight();
self.itemsPerRow=self.getItemsPerRow();self.shuffle(self.group)});else self.shuffle(self.group)};Shuffle.prototype={constructor:Shuffle,shuffle:function(category){var self=this;if(!category)category="all";self.$items.removeClass("concealed filtered");if($.isFunction(category))self.$items.each(function(){var $item=$(this);$item.addClass(category($item,self)?"filtered":"concealed")});else{self.group=category;if(category!=="all")self.$items.each(function(){var keys=$(this).data("groups");if($.inArray(category,
keys)===-1){$(this).addClass("concealed");return}else $(this).addClass("filtered")});else self.$items.addClass("filtered")}self.visibleItems=self.$items.filter(".filtered").length;self.fire("shrink");self.shrink();self.fire("filter");self.filter();self.resizeContainer()},getItemsPerRow:function(){var self=this,totalWidth=self.$container.width(),num=Math.floor(totalWidth/self.itemWidth);if(num*(self.itemWidth+self.marginRight)-self.marginRight>totalWidth)num-=1;return num},resizeContainer:function(){var self=
this,gridHeight=Math.ceil(self.visibleItems/self.itemsPerRow)*(self.itemHeight+self.marginTop)-self.marginTop;self.$container.css("height",gridHeight+"px")},fire:function(name){this.$container.trigger(name+".shuffle",[this])},shrink:function(){var self=this,$concealed=self.$items.filter(".concealed");if($concealed.length===0)return;self.shrinkTransitionEnded=false;$concealed.each(function(){var $this=$(this),x=parseInt($this.attr("data-x"),10),y=parseInt($this.attr("data-y"),10);if(!x)x=0;if(!y)y=
0;self.transition({from:"shrink",$this:$this,x:x,y:y,left:x+self.itemWidth/2+"px",top:y+self.itemHeight/2+"px",scale:0.001,opacity:0,height:"0px",width:"0px",callback:self.shrinkEnd})})},layout:function(items,fn){var self=this,y=0;if(items.length===0)return;self.layoutTransitionEnded=false;$.each(items,function(index){var $this=$(items[index]),x=index%self.itemsPerRow*(self.itemWidth+self.marginRight),row=Math.floor(index/self.itemsPerRow);if(index%self.itemsPerRow===0)y=row*(self.itemHeight+self.marginTop);
$this.attr({"data-x":x,"data-y":y});self.transition({from:"layout",$this:$this,x:x,y:y,left:x+"px",top:y+"px",scale:1,opacity:1,height:self.itemHeight+"px",width:self.itemWidth+"px",callback:fn})})},filter:function(){var self=this;if(self.keepSorted&&self.lastSort)self.sort(self.lastSort,true);else{var items=self.$items.filter(".filtered").get();self.layout(items,self.filterEnd)}},sort:function(opts,fromFilter){var self=this,items=self.$items.filter(".filtered").sorted(opts);self.layout(items,function(){if(fromFilter)self.filterEnd();
self.sortEnd()});self.lastSort=opts},setPrefixedCss:function($el,prop,value){$el.css(this.prefixed(prop),value)},getPrefixed:function(prop){var styleName=this.prefixed(prop);return styleName?styleName.replace(/([A-Z])/g,function(str,m1){return"-"+m1.toLowerCase()}).replace(/^ms-/,"-ms-"):styleName},transition:function(opts){var self=this,transform,complete=function(){if(!self.layoutTransitionEnded&&opts.from==="layout"){opts.callback.call(self);self.layoutTransitionEnded=true}else if(!self.shrinkTransitionEnded&&
opts.from==="shrink"){opts.callback.call(self);self.shrinkTransitionEnded=true}};if(self.supported){if(self.threeD)transform="translate3d("+opts.x+"px, "+opts.y+"px, 0) scale3d("+opts.scale+", "+opts.scale+", 1)";else transform="translate("+opts.x+"px, "+opts.y+"px) scale("+opts.scale+", "+opts.scale+")";opts.$this.css("opacity",opts.opacity);self.setPrefixedCss(opts.$this,"transform",transform);opts.$this.one(self.transitionEndName,complete)}else opts.$this.stop().animate({left:opts.left,top:opts.top,
opacity:opts.opacity,height:opts.height,width:opts.width},self.speed,"swing",complete)},resized:function(){var self=this;self.itemWidth=self.$items.filter(".filtered").outerWidth();self.itemHeight=self.$items.filter(".filtered").outerHeight();self.itemsPerRow=self.getItemsPerRow();self.filter();self.resizeContainer()},shrinkEnd:function(){this.fire("shrunk")},filterEnd:function(){this.fire("filtered")},sortEnd:function(){this.fire("sorted")},destroy:function(){var self=this;self.$container.removeAttr("style").removeData("shuffle");
$(window).off(".shuffle");self.$items.removeAttr("style data-y data-x").removeClass("concealed filtered")}};$.fn.shuffle=function(opts,sortObj){return this.each(function(){var $this=$(this),shuffle=$this.data("shuffle");if(!shuffle){shuffle=new Shuffle($this,opts);$this.data("shuffle",shuffle)}if($.isFunction(opts))shuffle.shuffle(opts);else if(typeof opts==="string")if(opts==="sort")shuffle.sort(sortObj);else if(opts==="destroy")shuffle.destroy();else shuffle.shuffle(opts)})};$.fn.shuffle.options=
{group:"all",speed:800,easing:"ease-out",keepSorted:true};$.fn.shuffle.settings={supported:Modernizr.csstransforms&&Modernizr.csstransitions,prefixed:Modernizr.prefixed,threeD:Modernizr.csstransforms3d}})(jQuery,Modernizr);
